version: '3.8'
services:
  influxdb:
    build: ./influxdb
    # image intentionally omitted to force local build
    user: root
    ports:
      - "8086:8086"
      - "8181:8181"
    env_file:
      - .env
    environment:
      INFLUXDB_3_ADMIN_TOKEN: "${INFLUXDB_3_ADMIN_TOKEN}"
      INFLUXDB_ORG: "${INFLUXDB_ORG}"
      INFLUXDB_BUCKET: "${INFLUXDB_BUCKET}"
      RUST_LOG: "influxdb3_server=trace,hyper=trace,tower_http=trace"
    volumes:
      - influxdb-data:/var/lib/influxdb
    healthcheck:
      # Prefer using INFLUX_TOKEN (the runtime apiv3 secret) if available.
      # Use a small container-local helper script which reads a runtime token file (/run/influx_token)
      # written by the init script. To avoid aggressive MissingToken log noise during startup,
      # give the container a longer start_period and less frequent probes.
      test: ["CMD-SHELL", "/usr/local/bin/healthcheck.sh | grep -q \"^[12][0-9][0-9]\""]
      interval: 15s
      timeout: 3s
      retries: 5
      start_period: 60s

  workload:
    build:
      context: ./workload
      dockerfile: Dockerfile
    container_name: workload
    depends_on:
      - influxdb
    env_file:
      - .env
    environment:
      INFLUX_HOST: proxy
      INFLUX_PORT: 8182
      INFLUX_ORG: ${INFLUX_ORG}
      INFLUX_TOKEN: ${INFLUX_TOKEN}
      SCENARIO: ${SCENARIO}
      POINTS: ${POINTS}
      MEASUREMENTS: ${MEASUREMENTS}
      TAGS: ${TAGS}
      BATCH_SIZE: ${BATCH_SIZE}
      PARALLEL_CLIENTS: ${PARALLEL_CLIENTS}
      TIMESTAMP_SPAN_SEC: ${TIMESTAMP_SPAN_SEC}
      SERIES_MULTIPLIER: ${SERIES_MULTIPLIER}
      DURATION_SEC: ${DURATION_SEC}
      REPORT_NAME: ${REPORT_NAME}
      WORKLOAD_LOG_DIR: ${WORKLOAD_LOG_DIR:-/logs/workload}
      SCENARIO_MATRIX_PATH: /app/config/scenario_matrix.yaml
      # Ensure local traffic to the influxdb service bypasses proxies
      NO_PROXY: "localhost,127.0.0.1,influxdb"
      HTTP_PROXY: ""
      HTTPS_PROXY: ""
    volumes:
      - ./logs/workload:${WORKLOAD_LOG_DIR:-/logs/workload}
      - ./workload/config/scenario_matrix.yaml:/app/config/scenario_matrix.yaml:ro
    command: ["/entrypoint.sh"]

  proxy:
    build:
      context: ./proxy
      dockerfile: Dockerfile
    ports:
      - "8182:8182"
    depends_on:
      - influxdb
    volumes:
      - ./logs/proxy:/var/log/nginx
    container_name: influx-proxy

volumes:
  influxdb-data: {}
